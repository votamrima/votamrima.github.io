---
layout: single
title: "Creating Systemd Tasks for Applications and Podman Rootless Containers"
subtitle: ""
date: 2021-12-15 07:15:00 +0100
background: '/image/01.jpg'
tags: ['linux', 'podman', 'container']
---

{% raw %}

In this article, I'll guide you through the process of creating a simple service startup job in Linux, using systemd. This method is particularly useful for both standard applications and rootless containers managed by Podman.

## Sample systemd file

Below is a sample service file for systemd:

````bash
[Unit]
Description=Description for application
After=network.target

[Service]
User=<user>
Group=<group>
WorkingDirectory=<path where running file is located>
Environment=<path with environment variable PATH "PATH=/location">
EnvironmentFile=<path to environment file>
ExecStart=<a command with necessary parameters to start application>

[Install]
WantedBy=multi-user.target
````

Replace ``<user>, <group>, <path where running file is located>, <path with environment variable>, <path to environment file>, and <a command with necessary parameters to start application>`` with the appropriate values for your application.

## Running and activating tasks

Place the service file in ``/etc/systemd/system``. Name the file as you wish, but ensure it has a ``.service`` extension, like ``testapp.service``.

Reload the systemd daemon after creating the file:

````bash
sudo systemctl daemon-reload
````

Start the application:

````bash
sudo systemctl start testapp.service
````

To have the application start automatically at boot:

````bash
sudo systemctl enable testapp.service
````


## Running Rootless Containers with Podman
For automating the start and stop of a rootless container with Podman, follow these steps:

1. **Generate the systemd unit file and update it:**

Use Podman to generate a systemd unit file:

````bash
[admin@podman ~]$ podman generate systemd --new --files --name registry
/home/admin/container-registry.service
````

This command will create a file like ``container-registry.service``. You can then customize this file as needed. For instance:

````bash

# container-registry2.service

# autogenerated by Podman 4.0.2

# Mon Jun  6 19:38:56 CEST 2022

[Unit]
Description=Podman container-registry2.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStartPre=/bin/rm -f %t/%n.ctr-id
ExecStart=/usr/bin/podman start registry2
ExecStop=/usr/bin/podman stop registry2
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target

````

2. **Install the generated unit file:**

For rootless container I need to store the unit file in ``~/.config/systemd/user/``. For the root container copy the file to ``/etc/systemd/system/``. 

````bash
cp container-registry.service ~/.config/systemd/user/registry.service
````

Enable the service with the ``--user`` flag:

````bash
[admin@podman ~]$ systemctl --user enable registry.service
````

3. **Enable systemd login persistence:**

To ensure the service remains active after logout, enable lingering for your user:

````bash
loginctl enable-linger <username>
````

Replace ``<username>`` with your actual username.

And that's it! You now have a systemd service for your application and a Podman rootless container, both configured for automatic startup and management.

This method provides a seamless and efficient way to manage application and container startups in a Linux environment, ensuring that your services are always up and running as needed.

## Reference
- [podman generate systemd](https://docs.podman.io/en/latest/markdown/podman-generate-systemd.1.html)
- other resources

{% endraw %}
